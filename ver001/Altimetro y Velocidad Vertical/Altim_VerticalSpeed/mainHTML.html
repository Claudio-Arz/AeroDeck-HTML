<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calibración Altímetro y Velocidad Vertical</title>
<style>
  body {
    background: #082032;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    padding-top: 30px;
  }

  #container {
    display: inline-block;
    position: relative;
    width: 300px;
    height: 300px;
  }

  .compass-outer {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #1d3958, #111820);
    box-shadow: 0 0 10px #000, 0 0 25px #000;
    border: 4px solid #ff0000;
  }

  .compass-scale {
    position: absolute;
    inset: 10px;
    border-radius: 50%;
    background:
      repeating-conic-gradient(#ffffff 0deg 2deg, transparent 2deg 36deg),
      repeating-conic-gradient(#cccccc 0deg 1deg, transparent 1deg 18deg);
    mask-image: radial-gradient(circle, transparent 60%, black 61%);
    -webkit-mask-image: radial-gradient(circle, transparent 60%, black 61%);
  }

  .compass-numbers {
    position: absolute;
    inset: 0;
    pointer-events: none;
    font-size: 20px;
    font-weight: bold;
    color: #ffffff;
    transform: rotate(-90deg);
  }

  .compass-numbers span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform:
      translate(-50%, -50%)
      rotate(calc(var(--angle) * 1deg))
      translate(90px)
      rotate(-90deg);
  }

  .needle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 90px solid #ffcc33;
    transform-origin: bottom center;
    transform: translate(-50%, -100%) rotate(0deg);
    filter: drop-shadow(0 0 4px #000);
  }

  .needle-center {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #e92084, #a20202);
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px #000;
    border: 2px solid #222;
  }

  #heading-value {
    position: absolute;
     left: 50%; 
     top: 50%;
     transform: translate(-50%, -50%);
     font-size: 24px;
    margin-top: 0;
    width: 80px;
    text-align: center;
    z-index: 10;
    background: rgba(8,32,50,0.7);
    border-radius: 6px;
    pointer-events: none;
  }

  /* Estilos para el control deslizante */
  .slider-container {
    margin-top: 20px;
    color: #ffffff;
  }

  .slider {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: #444;
    outline: none;
    opacity: 0.7;
    transition: opacity .2s;
  }

  .slider:hover {
    opacity: 1;
  }

  .slider-value {
    font-size: 18px;
    margin-top: 10px;
  }
</style>
</head>

<body>
<div style="margin-bottom:20px;">
  <strong>IP del sistema:</strong> <span id="esp32-ip">Cargando...</span><br>
  <small>Conéctate a esta IP desde cualquier dispositivo en la misma red WiFi.</small>
</div>
<h2>Altímetro y Velocidad Vertical</h2>

<div id="container">
  <div class="compass-outer"></div>
  <div class="compass-scale"></div>
  <div class="compass-numbers">
    <span style="--angle:0">0</span>
    <span style="--angle:36">1</span>
    <span style="--angle:72">2</span>
    <span style="--angle:108">3</span>
    <span style="--angle:144">4</span>
    <span style="--angle:180">5</span>
    <span style="--angle:216">6</span>
    <span style="--angle:252">7</span>
    <span style="--angle:288">8</span>
    <span style="--angle:324">9</span>
  </div>
  <div id="needle" class="needle"></div>
  <div class="needle-center"></div>
   <div id="heading-value">--</div>
</div>


<div id="container-vs" style="display:inline-block; position:relative; width:300px; height:300px; margin-left:40px;">
  <div class="compass-outer"></div>
  <div class="compass-scale"></div>
  <div class="compass-numbers">
    <span style="--angle:198">-20</span>
    <span style="--angle:234">-10</span>
    <span style="--angle:270">0</span>
    <span style="--angle:306">+10</span>
    <span style="--angle:342">+20</span>
  </div>
  <div id="needle-vs" class="needle"></div>
  <div class="needle-center"></div>
  <div id="vs-center-value" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:24px;width:80px;text-align:center;z-index:10;background:rgba(8,32,50,0.7);border-radius:6px;pointer-events:none;">--</div>
</div>




<!-- Control deslizante para velocidad vertical -->
<div class="slider-container">
  <input type="range" min="-127" max="127" value="0" class="slider" id="vs-slider">
  <div class="slider-value" id="vs-slider-value">0</div>
</div>

<script>
let ws = new WebSocket("ws://" + location.hostname + ":81");

ws.onmessage = (msg) => {
  let data = JSON.parse(msg.data);
  let heading = data.heading;
  let verticalSpeed = data.verticalSpeed ?? 0;
  let vsSliderValueServer = data.vsSliderValue;

  // Actualiza instrumentos
  let angle = (heading % 1000) * 360 / 1000;
  document.getElementById("needle").style.transform =
    `translate(-50%, -100%) rotate(${angle}deg)`;
  document.getElementById("heading-value").textContent =
    Math.round(heading);
  let vsAngle = 270 + verticalSpeed * 36;
  document.getElementById("needle-vs").style.transform =
    `translate(-50%, -100%) rotate(${vsAngle}deg)`;
  document.getElementById("vs-center-value").textContent =
    Math.round(verticalSpeed * 1000);

  // Sincroniza el slider si el valor recibido es diferente
  if (typeof vsSlider !== 'undefined' && typeof vsSliderValueServer !== 'undefined') {
    if (vsSlider.value != vsSliderValueServer) {
      vsSlider.value = vsSliderValueServer;
      vsSliderValue.textContent = vsSliderValueServer;
    }
  }
};
</script>

<script>
// Control deslizante para velocidad vertical
const vsSlider = document.getElementById("vs-slider");
const vsSliderValue = document.getElementById("vs-slider-value");
vsSlider.addEventListener("input", function() {
  vsSliderValue.textContent = this.value;
  // Enviar valor al ESP32 por WebSocket
  if(ws.readyState === 1) {
    ws.send(JSON.stringify({ setVerticalSpeed: Number(this.value) }));
  }
});
</script>

</body>
</html>