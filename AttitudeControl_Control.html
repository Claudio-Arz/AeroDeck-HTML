<div style="display: flex; flex-direction: column; align-items: center;">
  <h2 style="margin-bottom: 10px;">Control Pitch & Roll</h2>
  <div class="joystick-container" id="joystick">
    <div class="joystick-base"></div>
    <div class="joystick-knob" id="knob"></div>
  </div>
  <div class="coords" id="coords">roll: 0°, pitch: 0°</div>
</div>

<style>
  .joystick-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
    user-select: none;
    touch-action: none;
    display: block;
  }
  .joystick-base {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #444;
    border: 4px solid #888;
    box-shadow: 0 0 16px #000a;
  }
  .joystick-knob {
    position: absolute;
    width: 40px;
    height: 40px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: #fff;
    border: 3px solid #2196f3;
    box-shadow: 0 0 8px #2196f388;
    cursor: grab;
    transition: box-shadow 0.2s;
    z-index: 2;
    touch-action: none;
  }
  .joystick-knob:active {
    box-shadow: 0 0 16px #2196f3cc;
    cursor: grabbing;
  }
  .coords {
    font-size: 1.2em;
    margin-top: 12px;
    letter-spacing: 1px;
    text-align: center;
    width: 200px;
  }
</style>

<script>
  // WebSocket para enviar roll y pitch
  let ws;
  if (window.location.protocol.startsWith('http')) {
    ws = new WebSocket('ws://' + location.hostname + ':81/');
  }
  const container = document.getElementById('joystick');
  const knob = document.getElementById('knob');
  const coords = document.getElementById('coords');
  const size = 200;
  const knobSize = 40;
  const radius = (size - knobSize) / 2;
  let dragging = false;

  let knobPos = {x: 0, y: 0};
  function setKnob(x, y) {
    knobPos.x = x;
    knobPos.y = y;
    knob.style.left = `${x + size/2}px`;
    knob.style.top = `${y + size/2}px`;
    // Mapear x a roll (-30 a 30)
    const roll = Math.round((x / radius) * 30 * 10) / 10; // 1 decimal
    // Mapear y a pitch (-50 a 50)
    const pitchRaw = Math.round((y / radius) * 50 * 10) / 10; // -50 a 50
    // Convertir pitch a grados según escala: 25=10°, 12.5=5°, 50=20°
    // pitchGrados = pitchRaw * 0.4
    const pitchDeg = Math.round((pitchRaw * 0.4) * 10) / 10;
    coords.textContent = `roll: ${roll}°, pitch: ${pitchDeg}°`;
    // Enviar roll y pitch (en grados reales) por WebSocket
    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ roll: roll, pitch: pitchDeg }));
    }
  }

  function getRelativeCoords(e) {
    const rect = container.getBoundingClientRect();
    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
    let clientY = e.touches ? e.touches[0].clientY : e.clientY;
    let x = clientX - rect.left - size/2;
    let y = clientY - rect.top - size/2;
    // Limitar dentro del círculo
    const dist = Math.sqrt(x*x + y*y);
    if (dist > radius) {
      x = x * radius / dist;
      y = y * radius / dist;
    }
    return {x: Math.round(x), y: Math.round(y)};
  }

  function onMove(e) {
    if (!dragging) return;
    e.preventDefault();
    const {x, y} = getRelativeCoords(e);
    setKnob(x, y);
  }

  function animateToCenter() {
    const start = {x: knobPos.x, y: knobPos.y};
    const duration = 4000; // ms
    const startTime = performance.now();
    function animate(now) {
      const elapsed = now - startTime;
      const t = Math.min(elapsed / duration, 1);
      // Ease-out
      const ease = 1 - Math.pow(1 - t, 2);
      const x = Math.round(start.x * (1 - ease));
      const y = Math.round(start.y * (1 - ease));
      setKnob(x, y);
      if (t < 1) {
        requestAnimationFrame(animate);
      } else {
        setKnob(0, 0);
      }
    }
    requestAnimationFrame(animate);
  }
  function onEnd() {
    dragging = false;
    animateToCenter();
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onEnd);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onEnd);
  }

  knob.addEventListener('mousedown', function(e) {
    dragging = true;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
  });
  knob.addEventListener('touchstart', function(e) {
    dragging = true;
    document.addEventListener('touchmove', onMove, {passive: false});
    document.addEventListener('touchend', onEnd);
  });

  // Inicializar en el centro
  setKnob(0, 0);
</script>





