


<div id="rpm-container" style="grid-row: 1; grid-column: 4;">
  <div style="display: flex; justify-content: center; align-items: flex-start; gap: 60px; margin-bottom: 32px;">
    <div id="container">
      <img src="https://1drv.ms/i/c/976676efea6bc5cc/IQSq7R2SSyVBTr7XIEyJNr9iAdnoYbqY_Gtz4MnhCUnEMxU?width=480&height=480" alt="Tacómetro RPM">
      <div id="needle" class="needle"></div>
      <div class="needle-center"></div>
      <div id="rpm-value" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:32px;width:100px;text-align:center;z-index:20;background:rgba(8,32,50,0.85);border-radius:10px;pointer-events:none;color:#fff;box-shadow:0 0 8px #000;">--</div>
    </div>
  </div>
</div>

<!-- Control deslizante para motor -->
<div id="rpm-controls" style="grid-row: 1; grid-column: 6;">
  <div class="grid-item slider-vertical" >
    <div style="text-align:center;font-weight:bold;color:#fff;margin-bottom:4px;">RPM</div>
    <input type="range" min="0" max="3000" value="0" class="slider" id="rpm-slider" orient="vertical">
    <div class="slider-value" id="rpm-slider-value">0</div>
    <button id="start-btn-slider" style="height:48px;font-size:18px;padding:8px 12px;margin-top:12px;border-radius:8px;">Start</button>
    <button id="noice-btn" style="height:40px;font-size:16px;padding:6px 10px;margin-top:10px;background:#444;color:#fff;border-radius:8px;border:none;cursor:pointer;">Noice: OFF</button>
  </div>
</div>


<script>


let ws = new WebSocket("ws://" + location.hostname + ":81");
let isUserSliding = false;


ws.onmessage = (msg) => {
  let data = JSON.parse(msg.data);
  let rpm = data.rpm;
  window.currentRPM = rpm;
  // Solo actualizar la aguja si el usuario NO está moviendo el slider
  if (!isUserSliding) {
    updateNeedleAndValue(rpm);
    const slider = document.getElementById("rpm-slider");
    if (slider) slider.value = rpm;
    const sliderValue = document.getElementById("rpm-slider-value");
    if (sliderValue) sliderValue.textContent = rpm;
  }
};

// Al presionar el botón Start principal, enviar mensaje al ESP32 para que ejecute la rutina
document.getElementById("start-btn").addEventListener("click", function() {
  if(ws.readyState === 1) {
    ws.send(JSON.stringify({ startMotorRoutine: true }));
  }
});

// Al mover el slider, enviar el valor al ESP32
document.getElementById("rpm-slider").addEventListener("input", function(e) {
  isUserSliding = true;
  const value = parseInt(e.target.value);
  document.getElementById("rpm-slider-value").textContent = value;
  // Mover la aguja instantáneamente en el frontend
  updateNeedleAndValue(value);
  // Enviar el valor al ESP32 en background
  if(ws.readyState === 1) {
    ws.send(JSON.stringify({ setRPMSpeed: value }));
  }
});

// Cuando el usuario deja de mover el slider, permitir que el ESP32 vuelva a actualizar
document.getElementById("rpm-slider").addEventListener("change", function(e) {
  isUserSliding = false;
});

// Al presionar el botón Start del slider, enviar rutina
document.getElementById("start-btn-slider").addEventListener("click", function() {
  if(ws.readyState === 1) {
    ws.send(JSON.stringify({ startMotorRoutine: true }));
  }
});

// Botón de ruido
document.getElementById("noice-btn").addEventListener("click", function() {

  noiceOn = !noiceOn;
});
</script>

